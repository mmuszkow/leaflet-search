/* 
 * Leaflet Control Search v1.5.7 - 2015-05-07 
 * 
 * Copyright 2014 Stefano Cudini 
 * stefano.cudini@gmail.com 
 * http://labs.easyblog.it/ 
 * 
 * Licensed under the MIT license. 
 * 
 * Demo: 
 * http://labs.easyblog.it/maps/leaflet-search/ 
 * 
 * Source: 
 * git@github.com:stefanocudini/leaflet-search.git 
 * 
 */
(function(){L.Control.Search=L.Control.extend({includes:L.Mixin.Events,options:{wrapper:"",url:"",jsonpParam:null,icon:"../img/search.png",layer:null,callData:null,propertyName:"title",propertyLoc:"loc",propertyPopup:"popup",callTip:null,filterJSON:null,minLength:1,initial:!0,autoType:!0,delayType:400,tooltipLimit:-1,tipAutoSubmit:!0,autoResize:!0,collapsed:!0,autoCollapse:!1,autoCollapseTime:1200,zoom:null,text:"Search...",textCancel:"Cancel",textErr:"Location not found",position:"topleft",animateLocation:!0,circleLocation:!0,markerLocation:!1,markerIcon:new L.Icon.Default,markerWithPopupIcon:new L.Icon.Default},initialize:function(t){L.Util.setOptions(this,t||{}),this._inputMinSize=this.options.text?this.options.text.length:10,this._layer=this.options.layer||new L.LayerGroup,this._filterJSON=this.options.filterJSON||this._defaultFilterJSON,this._autoTypeTmp=this.options.autoType,this._countertips=0,this._recordsCache={},this._curReq=null},onAdd:function(e){return this._map=e,this._container=L.DomUtil.create("div","leaflet-control-search leaflet-bar"),this._bar_holder=L.DomUtil.create("div","search-bar-holder",this._container),this._input=this._createInput(this.options.text,"search-input leaflet-bar"),this._cancel=this._createCancel(this.options.textCancel,"search-cancel"),this._button=this._createButton(this.options.text,"search-button"),this._button.style.backgroundImage="url("+this.options.icon+")",this._tooltip=this._createTooltip("search-tooltip"),this._alert=this._createAlert("search-alert"),this.options.collapsed===!1&&this.expand(this.options.collapsed),(this.options.circleLocation||this.options.markerLocation||this.options.markerIcon||this.options.markerWithPopupIcon)&&(this._markerLoc=new t([0,0],{showCircle:this.options.circleLocation,showMarker:this.options.markerLocation,icon:this.options.markerIcon,iconWithPopup:this.options.markerWithPopupIcon})),this.setLayer(this._layer),e.on({resize:this._handleAutoresize},this),this._container},addTo:function(t){return this.options.wrapper?(this._container=this.onAdd(t),this._wrapper=L.DomUtil.get(this.options.wrapper),this._wrapper.style.position="relative",this._wrapper.appendChild(this._container)):L.Control.prototype.addTo.call(this,t),this},onRemove:function(){this._recordsCache={}},_getPath:function(t,e){var i=e.split("."),o=i.pop(),s=i.length,n=i[0],r=1;if(s>0)for(;(t=t[n])&&s>r;)n=i[r++];return t?t[o]:void 0},setLayer:function(t){return this._layer=t,this._layer.addTo(this._map),this._markerLoc&&this._layer.addLayer(this._markerLoc),this},showAlert:function(t){t=t||this.options.textErr,this._alert.style.display="block",this._alert.innerHTML=t,clearTimeout(this.timerAlert);var e=this;return this.timerAlert=setTimeout(function(){e.hideAlert()},this.options.autoCollapseTime),this},hideAlert:function(){return this._alert.style.display="none",this},cancel:function(){return this._input.value="",this._handleKeypress({keyCode:8}),this._input.size=this._inputMinSize,this._input.focus(),this._cancel.style.display="none",this},expand:function(t){var e=parseFloat(getComputedStyle(this._input,null).getPropertyValue("border-bottom-width")),i=parseFloat(getComputedStyle(this._input,null).getPropertyValue("border-top-width")),o=parseFloat(getComputedStyle(this._input,null).getPropertyValue("padding-bottom")),s=parseFloat(getComputedStyle(this._input,null).getPropertyValue("padding-top"));return this._input.style.height=this._button.clientHeight-e-i-o-s+"px",t=t||!0,this._input.style.display="block",this._button.style.backgroundImage="url(../www/img/search.png)",L.DomUtil.addClass(this._container,"search-exp"),0!=t&&(this._input.focus(),this._map.on("dragstart click",this.collapse,this)),this},collapse:function(){return this._hideTooltip(),this.cancel(),this._alert.style.display="none",this._button.style.backgroundImage="url("+this.options.icon+")",this._input.blur(),this.options.collapsed&&(this._input.style.display="none",this._cancel.style.display="none",L.DomUtil.removeClass(this._container,"search-exp"),this._map.off("dragstart click",this.collapse,this)),this.fire("search_collapsed"),this},collapseDelayed:function(){if(!this.options.autoCollapse)return this;var t=this;return clearTimeout(this.timerCollapse),this.timerCollapse=setTimeout(function(){t.collapse()},this.options.autoCollapseTime),this},collapseDelayedStop:function(){return clearTimeout(this.timerCollapse),this},_createAlert:function(t){var e=L.DomUtil.create("div",t,this._container);return e.style.display="none",L.DomEvent.on(e,"click",L.DomEvent.stop,this).on(e,"click",this.hideAlert,this),e},_createInput:function(t,e){this._input_holder=L.DomUtil.create("div","search-input-holder",this._bar_holder);var i=L.DomUtil.create("label",e,this._input_holder),o=L.DomUtil.create("input",e,this._input_holder);return o.type="text",o.size=this._inputMinSize,o.value="",o.autocomplete="off",o.autocorrect="off",o.autocapitalize="off",o.placeholder=t,o.style.display="none",o.role="search",o.id=o.role+o.type+o.size,i.htmlFor=o.id,i.style.display="none",i.value=t,L.DomEvent.disableClickPropagation(o).on(o,"keyup",this._handleKeypress,this).on(o,"keydown",this._handleAutoresize,this).on(o,"blur",this.collapseDelayed,this).on(o,"focus",this.collapseDelayedStop,this),o},_createCancel:function(t,e){var i=L.DomUtil.create("a",e,this._input_holder);return i.href="#",i.title=t,i.style.display="none",i.innerHTML="<span>&otimes;</span>",L.DomEvent.on(i,"click",L.DomEvent.stop,this).on(i,"click",this.cancel,this),i},_createButton:function(t,e){var i=L.DomUtil.create("a",e,this._bar_holder);return i.href="#",i.title=t,L.DomEvent.on(i,"click",L.DomEvent.stop,this).on(i,"click",this._handleSubmit,this).on(i,"focus",this.collapseDelayedStop,this).on(i,"blur",this.collapseDelayed,this),i},_createTooltip:function(t){var e=L.DomUtil.create("div",t,this._container);e.style.display="none";var i=this;return L.DomEvent.disableClickPropagation(e).on(e,"blur",this.collapseDelayed,this).on(e,"mousewheel",function(t){i.collapseDelayedStop(),L.DomEvent.stopPropagation(t)},this).on(e,"mouseover",function(){i.collapseDelayedStop()},this),e},_createTip:function(t,e){var i;if(this.options.callTip){if(i=this.options.callTip(t,e),"string"==typeof i){var o=L.DomUtil.create("div");o.innerHTML=i,i=o.firstChild}}else i=L.DomUtil.create("a",""),i.href="#",i.innerHTML=t;return L.DomUtil.addClass(i,"search-tip"),i._text=t,L.DomEvent.disableClickPropagation(i).on(i,"click",L.DomEvent.stop,this).on(i,"click",function(){this._input.value=t,this._handleAutoresize(),this._input.focus(),this._hideTooltip(),this.options.tipAutoSubmit&&this._handleSubmit()},this),i},_getUrl:function(){return"function"==typeof this.options.url?this.options.url():this.options.url},_filterRecords:function(t){var e,i,o=new RegExp("^[.]$|[[]|()*]","g"),s={};t=t.replace(o,""),e=this.options.initial?"^":"",i=new RegExp(e+t,"i");for(var n in this._recordsCache)i.test(n)&&(s[n]=this._recordsCache[n]);return s},showTooltip:function(){var t,e;this._countertips=0,t=this.options.layer?this._filterRecords(this._input.value):this._recordsCache,this._tooltip.innerHTML="",this._tooltip.currentSelection=-1;for(var i in t){if(++this._countertips==this.options.tooltipLimit)break;e=this._createTip(i,t[i]),e.style.width="inherit",this._tooltip.appendChild(e)}return this._countertips>0?(this._tooltip.style.display="block",this._autoTypeTmp&&this._autoType(),this._autoTypeTmp=this.options.autoType):this._hideTooltip(),this._tooltip.scrollTop=0,this._countertips},_hideTooltip:function(){return this._tooltip.style.display="none",this._tooltip.innerHTML="",0},_defaultFilterJSON:function(t){var e,i={},o=this.options.propertyName,s=this.options.propertyLoc,n=this.options.propertyPopup;if(L.Util.isArray(s))for(e in t)i[this._getPath(t[e],o)]=[L.latLng(t[e][s[0]],t[e][s[1]]),t[e][n]];else for(e in t)i[this._getPath(t[e],o)]=[L.latLng(this._getPath(t[e],s)),t[e][n]];return i},_recordsFromJsonp:function(t,e){var i=this;L.Control.Search.callJsonp=function(t){var o=i._filterJSON(t);e(o)};var o=L.DomUtil.create("script","search-jsonp",document.getElementsByTagName("body")[0]),s=L.Util.template(this._getUrl()+"&"+this.options.jsonpParam+"=L.Control.Search.callJsonp",{s:t});return o.type="text/javascript",o.src=s,{abort:function(){o.parentNode.removeChild(o)}}},_recordsFromAjax:function(t,e){void 0===window.XMLHttpRequest&&(window.XMLHttpRequest=function(){try{return new ActiveXObject("Microsoft.XMLHTTP.6.0")}catch(t){try{return new ActiveXObject("Microsoft.XMLHTTP.3.0")}catch(e){throw new Error("XMLHttpRequest is not supported")}}});var i=new XMLHttpRequest,o=L.Util.template(this._getUrl(),{s:t}),s={};i.open("GET",o);var n=this;return i.onreadystatechange=function(){if(4===i.readyState&&200===i.status){s=JSON.parse(i.responseText);var t=n._filterJSON(s);e(t)}},i.send(),i},_recordsFromLayer:function(){var e,i=this,o={},s=this.options.propertyName;return this._layer.eachLayer(function(n){n instanceof t||(n instanceof L.Marker||L.CircleMarker?i._getPath(n.options,s)?(e=n.getLatLng(),e.layer=n,o[i._getPath(n.options,s)]=e):i._getPath(n.feature.properties,s)?(e=n.getLatLng(),e.layer=n,o[i._getPath(n.feature.properties,s)]=e):console.log("propertyName '"+s+"' not found in marker",n):n.hasOwnProperty("feature")&&(n.feature.properties.hasOwnProperty(s)?(e=n.getBounds().getCenter(),e.layer=n,o[n.feature.properties[s]]=e):console.log("propertyName '"+s+"' not found in feature",n)))},this),o},_autoType:function(){var t=this._input.value.length,e=this._tooltip.firstChild._text,i=e.length;if(0===e.indexOf(this._input.value))if(this._input.value=e,this._handleAutoresize(),this._input.createTextRange){var o=this._input.createTextRange();o.collapse(!0),o.moveStart("character",t),o.moveEnd("character",i),o.select()}else this._input.setSelectionRange?this._input.setSelectionRange(t,i):this._input.selectionStart&&(this._input.selectionStart=t,this._input.selectionEnd=i)},_hideAutoType:function(){var t;if((t=this._input.selection)&&t.empty)t.empty();else if(this._input.createTextRange){t=this._input.createTextRange(),t.collapse(!0);var e=this._input.value.length;t.moveStart("character",e),t.moveEnd("character",e),t.select()}else this._input.getSelection&&this._input.getSelection().removeAllRanges(),this._input.selectionStart=this._input.selectionEnd},_handleKeypress:function(t){switch(t.keyCode){case 27:this.collapse();break;case 13:1==this._countertips&&this._handleArrowSelect(1),this._handleSubmit();break;case 38:this._handleArrowSelect(-1);break;case 40:this._handleArrowSelect(1);break;case 37:case 39:case 16:case 17:break;case 8:case 46:this._autoTypeTmp=!1;break;default:if(this._cancel.style.display=this._input.value.length?"block":"none",this._input.value.length>=this.options.minLength){var e=this;clearTimeout(this.timerKeypress),this.timerKeypress=setTimeout(function(){e._fillRecordsCache()},this.options.delayType)}else this._hideTooltip()}},_fillRecordsCache:function(){var t=this._input.value,e=this;this._curReq&&this._curReq.abort&&this._curReq.abort(),L.DomUtil.addClass(this._container,"search-load"),this.options.callData?this._curReq=this.options.callData(t,function(t){e._recordsCache=e._filterJSON(t),e.showTooltip(),L.DomUtil.removeClass(e._container,"search-load")}):this._getUrl()?this._curReq=this.options.jsonpParam?this._recordsFromJsonp(t,function(t){e._recordsCache=t,e.showTooltip(),L.DomUtil.removeClass(e._container,"search-load")}):this._recordsFromAjax(t,function(t){e._recordsCache=t,e.showTooltip(),L.DomUtil.removeClass(e._container,"search-load")}):this.options.layer&&(this._recordsCache=this._recordsFromLayer(),this.showTooltip(),L.DomUtil.removeClass(this._container,"search-load"))},_handleAutoresize:function(){this._input.style.maxWidth!=this._map._container.offsetWidth&&(this._input.style.maxWidth=L.DomUtil.getStyle(this._map._container,"width")),this.options.autoResize&&this._container.offsetWidth+45<this._map._container.offsetWidth&&(this._input.size=this._input.value.length<this._inputMinSize?this._inputMinSize:this._input.value.length)},_handleArrowSelect:function(t){var e=this._tooltip.hasChildNodes()?this._tooltip.childNodes:[];for(i=0;i<e.length;i++)L.DomUtil.removeClass(e[i],"search-tip-select");if(1==t&&this._tooltip.currentSelection>=e.length-1)L.DomUtil.addClass(e[this._tooltip.currentSelection],"search-tip-select");else if(-1==t&&this._tooltip.currentSelection<=0)this._tooltip.currentSelection=-1;else if("none"!=this._tooltip.style.display){this._tooltip.currentSelection+=t,L.DomUtil.addClass(e[this._tooltip.currentSelection],"search-tip-select"),this._input.value=e[this._tooltip.currentSelection]._text;var o=e[this._tooltip.currentSelection].offsetTop;o+e[this._tooltip.currentSelection].clientHeight>=this._tooltip.scrollTop+this._tooltip.clientHeight?this._tooltip.scrollTop=o-this._tooltip.clientHeight+e[this._tooltip.currentSelection].clientHeight:o<=this._tooltip.scrollTop&&(this._tooltip.scrollTop=o)}},_handleSubmit:function(){if(this._hideAutoType(),this.hideAlert(),this._hideTooltip(),"none"==this._input.style.display)this.expand();else if(""===this._input.value)this.collapse();else{var t=this._getLocation(this._input.value);t===!1?this.showAlert():(this.showLocation(t,this._input.value),this.fire("search_locationfound",{latlng:t,text:this._input.value,layer:t.layer?t.layer:null}))}},_getLocation:function(t){return this._recordsCache.hasOwnProperty(t)?this._recordsCache[t]:!1},showLocation:function(t,e){var i=t[0];return this.options.zoom?this._map.setView(i,this.options.zoom):this._map.panTo(i),this._markerLoc&&(this._markerLoc.setLatLng(i),this._markerLoc.setTitle(e),this._markerLoc.closePopup(),this._markerLoc.unbindPopup(),"undefined"!=typeof t[1]?(this._markerLoc.bindPopup(t[1]),this._markerLoc.setIcon(this.options.markerWithPopupIcon)):this._markerLoc.setIcon(this.options.markerIcon),this._markerLoc.show(),this.options.animateLocation&&this._markerLoc.animate()),this.options.autoCollapse&&this.collapse(),this}});var t=L.Marker.extend({includes:L.Mixin.Events,options:{radius:10,weight:3,color:"#e03",stroke:!0,fill:!1,title:"",icon:new L.Icon.Default,showCircle:!0,showMarker:!1},initialize:function(t,e){L.setOptions(this,e),L.Marker.prototype.initialize.call(this,t,e),this.options.showCircle&&(this._circleLoc=new L.CircleMarker(t,this.options))},onAdd:function(t){L.Marker.prototype.onAdd.call(this,t),this._circleLoc&&t.addLayer(this._circleLoc),this.hide()},onRemove:function(t){L.Marker.prototype.onRemove.call(this,t),this._circleLoc&&t.removeLayer(this._circleLoc)},setLatLng:function(t){return L.Marker.prototype.setLatLng.call(this,t),this._circleLoc&&this._circleLoc.setLatLng(t),this},setTitle:function(t){return t=t||"",this.options.title=t,this._icon&&(this._icon.title=t),this},show:function(){return this.options.showMarker&&(this._icon&&(this._icon.style.display="block"),this._shadow&&(this._shadow.style.display="block")),this._circleLoc&&this._circleLoc.setStyle({fill:this.options.fill,stroke:this.options.stroke}),this},hide:function(){return this._icon&&(this._icon.style.display="none"),this._shadow&&(this._shadow.style.display="none"),this._circleLoc&&this._circleLoc.setStyle({fill:!1,stroke:!1}),this},animate:function(){if(this._circleLoc){var t=this._circleLoc,e=200,i=10,o=parseInt(t._radius/i),s=this.options.radius,n=2.5*t._radius,r=0;t._timerAnimLoc=setInterval(function(){r+=.5,o+=r,n-=o,t.setRadius(n),s>n&&(clearInterval(t._timerAnimLoc),t.setRadius(s))},e)}return this}});L.Map.addInitHook(function(){this.options.searchControl&&(this.searchControl=L.control.search(this.options.searchControl),this.addControl(this.searchControl))}),L.control.search=function(t){return new L.Control.Search(t)}}).call(this);